<?xml version="1.0" encoding="UTF-8"?>
<!--
  PYAMBAR MSI Installer
  Build: wix build PYAMBAR.wxs Files.wxs -ext WixToolset.UI.wixext -ext WixToolset.Util.wixext -o dist/PYAMBAR_Installer.msi
  Requires: Files.wxs generated by build-msi.bat via `wix harvest`
-->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Package
    Name="PYAMBAR"
    Version="2.0.0"
    Manufacturer="Thiago Barreto Sobral Nunes"
    UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890"
    Language="1046"
    Codepage="1252"
    Compressed="yes">

    <!-- Detecta e remove versao anterior automaticamente -->
    <MajorUpgrade
      DowngradeErrorMessage="Uma versao mais recente do PYAMBAR ja esta instalada."
      Schedule="afterInstallInitialize" />

    <MediaTemplate EmbedCab="yes" />

    <!-- Diretorio de instalacao: %APPDATA%\pyRevit-Master\Extensions\PYAMBAR.extension -->
    <StandardDirectory Id="AppDataFolder">
      <Directory Id="PyRevitMasterDir" Name="pyRevit-Master">
        <Directory Id="ExtensionsDir" Name="Extensions">
          <Directory Id="INSTALLDIR" Name="PYAMBAR.extension" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- Feature principal: todos os arquivos da extensao -->
    <Feature Id="ProductFeature" Title="PYAMBAR" Level="1">
      <ComponentGroupRef Id="PyAMBARFiles" />
      <ComponentRef Id="RegistrationScript" />
    </Feature>

    <!-- Componente: script de registro (copiado temporariamente e executado) -->
    <Component Id="RegistrationScript" Directory="INSTALLDIR" Guid="B2C3D4E5-F6A7-8901-BCDE-F23456789012">
      <File Id="RegisterPS1" Source="register.ps1" Name="pyambar_register.ps1" KeyPath="yes" />
    </Component>

    <!-- CustomAction: registrar no pyRevit apos instalar -->
    <CustomAction
      Id="RegisterPyRevit"
      Directory="SystemFolder"
      Execute="deferred"
      Impersonate="yes"
      ExeCommand="cmd.exe /c powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File &quot;[INSTALLDIR]pyambar_register.ps1&quot; register"
      Return="ignore" />

    <!-- CustomAction: desregistrar ao desinstalar -->
    <CustomAction
      Id="UnregisterPyRevit"
      Directory="SystemFolder"
      Execute="deferred"
      Impersonate="yes"
      ExeCommand="cmd.exe /c powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden -File &quot;[INSTALLDIR]pyambar_register.ps1&quot; unregister"
      Return="ignore" />

    <InstallExecuteSequence>
      <!-- Registrar apenas em instalacao/atualizacao -->
      <Custom Action="RegisterPyRevit" After="InstallFiles" Condition='NOT (REMOVE="ALL")' />
      <!-- Desregistrar apenas em remocao -->
      <Custom Action="UnregisterPyRevit" Before="RemoveFiles" Condition='REMOVE="ALL"' />
    </InstallExecuteSequence>

    <!-- UI minima: dialog de boas-vindas + progresso + conclusao -->
    <ui:WixUI Id="WixUI_Minimal" />

    <!-- Textos de licenca: aceita sem exibir EULA -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />

    <!-- Informacoes de Programas e Recursos -->
    <Property Id="ARPHELPLINK" Value="https://github.com/thiagobarretosn-hue/PYAMBAR/issues" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/thiagobarretosn-hue/PYAMBAR" />
    <Property Id="ARPNOREPAIR" Value="1" />

  </Package>
</Wix>
